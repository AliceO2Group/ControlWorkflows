name: readout-dataflow
defaults:
  roc_ctp_emulator_enabled: "false"
  dd_enabled: "false"
  ddsched_enabled: "false"
  dcs_enabled: "false"
  qcdd_enabled: "false" # qcdd_enabled and minimal_dpl_enabled cannot be both true!
  minimal_dpl_enabled: "false"
  dpl_workflow: "none" # if specified, we use dpl_worfklow to choose what is between STFB and STFS. Otherwise, we fall to the old choice mechanism.
                       # available options: "none", "qc-daq", "minimal-dpl", "tof-compressor"
  stfb_standalone: "false"
  odc_enabled: "false"
  odcshim_enabled: "false"
  roc_cleanup_enabled: "true"
  fmq_cleanup_enabled: "false"
  monitoring_dpl_url: "no-op://"
  monitoring_qc_url: "no-op://"
  monitoring_dd_url: "no-op://"
  monitoring_readout_url: "no-op://"
  user: flp
  log_task_output: none
  fmq_rate_logging: "10"
roles:
  - name: host-{{ it }}
    for:
      range: "{{ hosts }}"
      var: it
    defaults:
      detector: "{{DetectorForHost( it )}}"
    vars:
      readout_cfg_uri_standalone: "consul-ini://{{ consul_endpoint }}/o2/components/readout/ANY/any/readout-standalone-{{ it }}"
      readout_cfg_uri_stfb: "consul-ini://{{ consul_endpoint }}/o2/components/readout/ANY/any/readout-stfb-{{ it }}"
      dd_discovery_ib_hostname: "{{ it }}-ib" # MUST be defined for all stfb and stfs
    constraints:
      - attribute: machine_id
        value: "{{ it }}"
    roles:
      - name: "readout"
        vars:
          readout_cfg_uri: '{{dd_enabled == "true" ? readout_cfg_uri_stfb : readout_cfg_uri_standalone}}'
        task:
          load: readout
      - name: o2-roc-ctp-emulators
        enabled: "{{roc_ctp_emulator_enabled == 'true'}}"
        defaults:
          roc_ctp_emulator_endpoints: '["#0"]'
        roles:
          - name: "endpoint-{{ endpoint_id }}"
            for:
              range: "{{roc_ctp_emulator_endpoints}}"
              var: endpoint_id
            roles:
              - name: o2-roc-ctp-emulator
                task:
                  load: "o2-roc-ctp-emulator"
                  trigger: enter_RUNNING
                  timeout: 10s
                  critical: false
      - name: o2-roc-cleanup
        enabled: "{{roc_cleanup_enabled == 'true'}}"
        task:
          load: "o2-roc-cleanup"
          trigger: DESTROY
          timeout: 10s
          critical: false

name: !public readout-dataflow
description: !public "Main workflow template for ALICE data taking"
defaults:
  ###############################
  # General Configuration Panel
  ###############################
  ctp_readout_enabled: #!public
    value: "false"
    type: bool
    label: "CTP Readout"
    description: "Enable/disable CTP readout"
    widget: checkBox
    panel: General_Configuration
    index: -300
  dcs_enabled: !public # TODO: if false, DCS panel should be disabled
    value: "false"
    type: bool
    label: "DCS"
    description: "Enable/disable DCS SOR/EOR commands"
    widget: checkBox
    panel: General_Configuration
    index: 0
  dd_enabled: !public
    value: "true"
    type: bool
    label: "Data Distribution (FLP)"
    description: "Enable/disable Data Distribution components running on FLPs (StfBuilder and StfSender)"
    widget: checkBox
    panel: General_Configuration
    index: 1
  epn_enabled: !public # TODO: this should be the single var that enables both ODC and DD Scheduler
    value: "false"
    type: bool
    label: "EPN"
    description: "Enable/disable EPN"
    widget: checkBox
    panel: General_Configuration
    index: 2    
  trg_enabled: !public
    value: "false"
    type: bool
    label: "TRG"
    description: "Enable/disable TRG"
    widget: checkBox
    panel: General_Configuration
    index: 3
  trg_global_run_enabled: !public
    value: "false"
    type: bool
    label: "TRG Global Run"
    description: "If enabled, send commands to CTP. If disabled, send commands to LTU."
    widget: checkBox
    panel: General_Configuration
    visibleif: $$trg_enabled === "true"
    index: 4
  ###############################
  # DCS and FLP Workflows Panel
  ###############################
  qc_remote_enabled: !public # TODO: if false, all per-detector remote QC workflows vars should be disabled
    value: "false"
    type: bool
    label: "QC node workflows"
    description: "Enable/disable running workflows on the QC nodes"
    widget: checkBox
    panel: FLP_Workflows
    index: -200
  cpv_dpl_workflow: !public
    value: "none"
    type: string
    label: "CPV FLP workflow"
    description: "Workflow to execute on the FLPs of this detector"
    widget: dropDownBox
    panel: FLP_Workflows
    values:
      - none
      - cpv-compressor
      - cpv-qc-compressor
      - cpv-pedestal-calib-qc
      - cpv-noise-calib-qc
      - cpv-physics
      - cpv-physics-testing
      - minimal-dpl
      - qc-daq
      - qcmn-daq-local
  cpv_qc_remote_workflow: !public
    value: "none"
    type: string
    label: "CPV QC node workflow"
    description: "Workflow to execute on QC servers for this detector"
    widget: dropDownBox
    panel: FLP_Workflows
    values:
      - none
      - cpv-physics-qcmn-epn-remote
      - qcmn-daq-remote
    visibleif: $$qc_remote_enabled === "true"  
  cpv_dcs_sor_parameters: !public
    value: "{}"
    type: string
    label: "CPV SOR parameters"
    description: "additional parameters for the DCS SOR"
    widget: editBox
    panel: DCS
    visibleif: $$dcs_enabled === "true"
  cpv_dcs_eor_parameters: !public
    value: "{}"
    type: string
    label: "CPV EOR parameters"
    description: "additional parameters for the DCS EOR"
    widget: editBox
    panel: DCS
    visibleif: $$dcs_enabled === "true"
  emc_dpl_workflow: !public
    value: "none"
    type: string
    label: "EMCAL FLP workflow"
    description: "Workflow to execute on the FLPs of this detector"
    widget: dropDownBox
    panel: FLP_Workflows
    values:
      - none
      - minimal-dpl
      - qc-daq
      - qcmn-daq-local
      - emc-qcmn-flp-local
  emc_qc_remote_workflow: !public
    value: "none"
    type: string
    label: "EMCAL QC node workflow"
    description: "Workflow to execute on QC servers for this detector"
    widget: dropDownBox
    panel: FLP_Workflows
    values:
      - none
      - emc-qcmn-flp-remote
      - emc-qcmn-epn-remote
      - emc-qcmn-epnall-remote
      - emc-qcmn-flpepn-remote
      - qcmn-daq-remote
    visibleif: $$qc_remote_enabled === "true"    
  emc_dcs_sor_parameters: !public
    value: "{}"
    type: string
    label: "EMCAL SOR parameters"
    description: "additional parameters for the DCS SOR"
    widget: editBox
    panel: DCS
    visibleif: $$dcs_enabled === "true"
  emc_dcs_eor_parameters: !public
    value: "{}"
    type: string
    label: "EMCAL EOR parameters"
    description: "additional parameters for the DCS EOR"
    widget: editBox
    panel: DCS
    visibleif: $$dcs_enabled === "true"
  fdd_dpl_workflow: !public
    value: "none"
    type: string
    label: "FDD FLP workflow"
    description: "Workflow to execute on the FLPs of this detector"
    widget: dropDownBox
    panel: FLP_Workflows
    values:
      - none
      - fdd-digits-qc-full-nocalib
      - fdd-digits-qc-full-nocalib-raw
      - fdd-digits-pipe
      - fdd-digits-qc-ds-pipe
      - fdd-digits-qc-ds
      - fdd-digits-qc
      - fdd-digits
      - minimal-dpl
      - qc-daq
      - qcmn-daq-local
  fdd_qc_remote_workflow: !public
    value: "none"
    type: string
    label: "FDD QC node workflow"
    description: "Workflow to execute on QC servers for this detector"
    widget: dropDownBox
    panel: FLP_Workflows
    values:
      - none
      - fdd-qcmn-remote
      - qcmn-daq-remote
    visibleif: $$qc_remote_enabled === "true"  
  fdd_dcs_sor_parameters: !public
    value: "{}"
    type: string
    label: "FDD SOR parameters"
    description: "additional parameters for the DCS SOR"
    widget: editBox
    panel: DCS
    visibleif: $$dcs_enabled === "true"
  fdd_dcs_eor_parameters: !public
    value: "{}"
    type: string
    label: "FDD EOR parameters"
    description: "additional parameters for the DCS EOR"
    widget: editBox
    panel: DCS
    visibleif: $$dcs_enabled === "true"
  ft0_dpl_workflow: !public
    value: "none"
    type: string
    label: "FT0 FLP workflow"
    description: "Workflow to execute on the FLPs of this detector"
    widget: dropDownBox
    panel: FLP_Workflows
    values:
      - none
      - ft0-digits-qc-full
      - ft0-digits-qc-full-raw
      - ft0-digits-qc-full-nocalib
      - ft0-digits-qc-full-nocalib-raw
      - ft0-digits-pipe
      - ft0-digits-qc-ds-pipe
      - ft0-digits-qc-ds-pipe-raw
      - ft0-digits-qc-ds
      - ft0-digits-qc-postproc-ds-pipe
      - ft0-digits-qc-postproc-ds
      - ft0-digits-qc
      - ft0-digits
      - minimal-dpl
      - qc-daq
      - qcmn-daq-local
  ft0_qc_remote_workflow: !public
    value: "none"
    type: string
    label: "FT0 QC node workflow"
    description: "Workflow to execute on QC servers for this detector"
    widget: dropDownBox
    panel: FLP_Workflows
    values:
      - none
      - ft0-qcmn-remote
      - qcmn-daq-remote
    visibleif: $$qc_remote_enabled === "true"  
  ft0_dcs_sor_parameters: !public
    value: "{}"
    type: string
    label: "FT0 SOR parameters"
    description: "additional parameters for the DCS SOR"
    widget: editBox
    panel: DCS
    visibleif: $$dcs_enabled === "true"
  ft0_dcs_eor_parameters: !public
    value: "{}"
    type: string
    label: "FT0 EOR parameters"
    description: "additional parameters for the DCS EOR"
    widget: editBox
    panel: DCS
    visibleif: $$dcs_enabled === "true"
  fv0_dpl_workflow: !public
    value: "none"
    type: string
    label: "FV0 FLP workflow"
    description: "Workflow to execute on the FLPs of this detector"
    widget: dropDownBox
    panel: FLP_Workflows
    values:
      - none
      - fv0-digits-qc-full
      - fv0-digits-qc-full-raw
      - fv0-digits-qc-full-nocalib
      - fv0-digits-qc-full-nocalib-raw
      - fv0-digits-pipe
      - fv0-digits-qc-ds-pipe
      - fv0-digits-qc-ds-pipe-raw
      - fv0-digits-qc-ds
      - fv0-digits-qc-postproc-ds-pipe
      - fv0-digits-qc-postproc-ds
      - fv0-digits-qc
      - fv0-digits
      - minimal-dpl
      - qc-daq
      - qcmn-daq-local
  fv0_qc_remote_workflow: !public
    value: "none"
    type: string
    label: "FV0 QC node workflow"
    description: "Workflow to execute on QC servers for this detector"
    widget: dropDownBox
    panel: FLP_Workflows
    values:
      - none
      - fv0-qcmn-remote
      - qcmn-daq-remote
    visibleif: $$qc_remote_enabled === "true"  
  fv0_dcs_sor_parameters: !public
    value: "{}"
    type: string
    label: "FV0 SOR parameters"
    description: "additional parameters for the DCS SOR"
    widget: editBox
    panel: DCS
    visibleif: $$dcs_enabled === "true"
  fv0_dcs_eor_parameters: !public
    value: "{}"
    type: string
    label: "FV0 EOR parameters"
    description: "additional parameters for the DCS EOR"
    widget: editBox
    panel: DCS
    visibleif: $$dcs_enabled === "true"
  its_dpl_workflow: !public
    value: "none"
    type: string
    label: "ITS FLP workflow"
    description: "Workflow to execute on the FLPs of this detector"
    widget: dropDownBox
    panel: FLP_Workflows
    values:
      - none
      - its-qc-fhr-fee
      - its-qc-fhr-fee-no-ds
      - its-qcmn-fhr-fee-local
      - its-qcmn-fhr-fee-no-ds-local
      - its-qcmn-fhr-fee-no-ds-entire-local
      - minimal-dpl
      - qc-daq
      - qcmn-daq-local
  its_qc_remote_workflow: !public
    value: "none"
    type: string
    label: "ITS QC node workflow"
    description: "Workflow to execute on QC servers for this detector"
    widget: dropDownBox
    panel: FLP_Workflows
    values:
      - none
      - its-qcmn-fhr-fee-remote
      - its-qcmn-fhr-fee-no-ds-remote
      - its-qcmn-fhr-fee-no-ds-entire-remote
      - its-qcmn-cluster-track-remote
      - its-qcmn-flp-epn-remote
      - its-qcmn-flp-epn-no-ds-remote
      - its-qcmn-epn-remote
      - its-qcmn-flp-epn-no-ds-nocluster-remote
      - qcmn-daq-remote
    visibleif: $$qc_remote_enabled === "true"  
  its_dcs_sor_parameters: !public
    value: "{}"
    type: string
    label: "ITS SOR parameters"
    description: "additional parameters for the DCS SOR"
    widget: editBox
    panel: DCS
    visibleif: $$dcs_enabled === "true"
  its_dcs_eor_parameters: !public
    value: "{}"
    type: string
    label: "ITS EOR parameters"
    description: "additional parameters for the DCS EOR"
    widget: editBox
    panel: DCS
    visibleif: $$dcs_enabled === "true"
  hmp_dpl_workflow: !public
    value: "none"
    type: string
    label: "HMPID FLP workflow"
    description: "Workflow to execute on the FLPs of this detector"
    widget: dropDownBox
    panel: FLP_Workflows
    values:
      - none
      - hmpid-raw-qc
      - hmpid-raw-qcmn-local
      - minimal-dpl
      - qc-daq
      - qcmn-daq-local
      - hmpid-raw-to-pedestals
  hmp_qc_remote_workflow: !public
    value: "none"
    type: string
    label: "HMPID QC node workflow"
    description: "Workflow to execute on QC servers for this detector"
    widget: dropDownBox
    panel: FLP_Workflows
    values:
      - none
      - hmpid-raw-qcmn-remote
      - qcmn-daq-remote
    visibleif: $$qc_remote_enabled === "true"  
  hmp_dcs_sor_parameters: !public
    value: "{}"
    type: string
    label: "HMPID SOR parameters"
    description: "additional parameters for the DCS SOR"
    widget: editBox
    panel: DCS
    visibleif: $$dcs_enabled === "true"
  hmp_dcs_eor_parameters: !public
    value: "{}"
    type: string
    label: "HMPID EOR parameters"
    description: "additional parameters for the DCS EOR"
    widget: editBox
    panel: DCS
    visibleif: $$dcs_enabled === "true"
  mch_dpl_workflow: !public
    value: "none"
    type: string
    label: "MCH FLP workflow"
    description: "Workflow to execute on the FLPs of this detector"
    widget: dropDownBox
    panel: FLP_Workflows
    values:
      - none
      - mch-qcmn-flp-digits-local
      - minimal-dpl
      - qc-daq
      - qcmn-daq-local
  mch_qc_remote_workflow: !public
    value: "none"
    type: string
    label: "MCH QC node workflow"
    description: "Workflow to execute on QC servers for this detector"
    widget: dropDownBox
    panel: FLP_Workflows
    values:
      - none
      - mch-qcmn-epn-digits-remote
      - mch-qcmn-flp-digits-remote
      - qcmn-daq-remote
      - mch-digits-epn
    visibleif: $$qc_remote_enabled === "true"  
  mch_dcs_sor_parameters: !public
    value: "{}"
    type: string
    label: "MCH SOR parameters"
    description: "additional parameters for the DCS SOR"
    widget: editBox
    panel: DCS
    visibleif: $$dcs_enabled === "true"
  mch_dcs_eor_parameters: !public
    value: "{}"
    type: string
    label: "MCH EOR parameters"
    description: "additional parameters for the DCS EOR"
    widget: editBox
    panel: DCS
    visibleif: $$dcs_enabled === "true"
  mft_dpl_workflow: !public
    value: "none"
    type: string
    label: "MFT FLP workflow"
    description: "Workflow to execute on the FLPs of this detector"
    widget: dropDownBox
    panel: FLP_Workflows
    values:
      - none
      - mft-decoder
      - mft-digits-qc
      - mft-raw-direct-qcmn-local
      - mft-raw-qc
      - mft-raw-qcmn-local
      - mft-full-qcmn-local
      - mft-raw-cluster-qcmn-local
      - minimal-dpl
      - qc-daq
      - qcmn-daq-local
  mft_qc_remote_workflow: !public
    value: "none"
    type: string
    label: "MFT QC node workflow"
    description: "Workflow to execute on QC servers for this detector"
    widget: dropDownBox
    panel: FLP_Workflows
    values:
      - none
      - mft-raw-direct-qcmn-remote
      - mft-raw-qcmn-remote
      - mft-full-qcmn-remote
      - mft-raw-cluster-qcmn-remote
      - qcmn-daq-remote
    visibleif: $$qc_remote_enabled === "true"  
  mft_dcs_sor_parameters: !public
    value: "{}"
    type: string
    label: "MFT SOR parameters"
    description: "additional parameters for the DCS SOR"
    widget: editBox
    panel: DCS
    visibleif: $$dcs_enabled === "true"
  mft_dcs_eor_parameters: !public
    value: "{}"
    type: string
    label: "MFT EOR parameters"
    description: "additional parameters for the DCS EOR"
    widget: editBox
    panel: DCS
    visibleif: $$dcs_enabled === "true"
  mid_dpl_workflow: !public
    value: "none"
    type: string
    label: "MID FLP workflow"
    description: "Workflow to execute on the FLPs of this detector"
    widget: dropDownBox
    panel: FLP_Workflows
    values:
      - none
      - mid-raw-decoder
      - mid-full-qcmn-local
      - minimal-dpl
      - qc-daq
      - qcmn-daq-local
  mid_qc_remote_workflow: !public
    value: "none"
    type: string
    label: "MID QC node workflow"
    description: "Workflow to execute on QC servers for this detector"
    widget: dropDownBox
    panel: FLP_Workflows
    values:
      - none
      - mid-qcmn-epn-digits
      - mid-full-qcmn-remote
      - qcmn-daq-remote
    visibleif: $$qc_remote_enabled === "true"  
  mid_dcs_sor_parameters: !public
    value: "{}"
    type: string
    label: "MID SOR parameters"
    description: "additional parameters for the DCS SOR"
    widget: editBox
    panel: DCS
    visibleif: $$dcs_enabled === "true"
  mid_dcs_eor_parameters: !public
    value: "{}"
    type: string
    label: "MID EOR parameters"
    description: "additional parameters for the DCS EOR"
    widget: editBox
    panel: DCS
    visibleif: $$dcs_enabled === "true"
  phs_dpl_workflow: !public
    value: "none"
    type: string
    label: "PHOS FLP workflow"
    description: "Workflow to execute on the FLPs of this detector"
    widget: dropDownBox
    panel: FLP_Workflows
    values:
      - none
      - phos-compressor-raw-qc
      - phos-compressor-raw-qcmn-local
      - phos-compressor-raw-qcmnt3-local
      - phos-compressor-raw-qct3
      - phos-compressor
      - phos-compressort3
      - phos-raw-clusters-local
      - minimal-dpl
      - qc-daq
      - qcmn-daq-local
  phs_qc_remote_workflow: !public
    value: "none"
    type: string
    label: "PHOS QC node workflow"
    description: "Workflow to execute on QC servers for this detector"
    widget: dropDownBox
    panel: FLP_Workflows
    values:
      - none
      - phos-compressor-raw-qcmn-remote
      - phos-compressor-raw-qcmnt3-remote
      - phos-raw-clusters-remote
      - qcmn-daq-remote
    visibleif: $$qc_remote_enabled === "true"  
  phs_dcs_sor_parameters: !public
    value: "{}"
    type: string
    label: "PHOS SOR parameters"
    description: "additional parameters for the DCS SOR"
    widget: editBox
    panel: DCS
    visibleif: $$dcs_enabled === "true"
  phs_dcs_eor_parameters: !public
    value: "{}"
    type: string
    label: "PHOS EOR parameters"
    description: "additional parameters for the DCS EOR"
    widget: editBox
    panel: DCS
    visibleif: $$dcs_enabled === "true"
  tof_dpl_workflow: !public
    value: "none"
    type: string
    label: "TOF FLP workflow"
    description: "Workflow to execute on the FLPs of this detector"
    widget: dropDownBox
    panel: FLP_Workflows
    values:
      - none
      - tof-compressor
      - tof-full-qcmn-local
      - tof-qcmn-compressor-local
      - minimal-dpl
      - qc-daq
      - qcmn-daq-local
  tof_qc_remote_workflow: !public
    value: "none"
    type: string
    label: "TOF QC node workflow"
    description: "Workflow to execute on QC servers for this detector"
    widget: dropDownBox
    panel: FLP_Workflows
    values:
      - none
      - qcmn-daq-remote
      - tof-full-qcmn-remote
      - tof-qcmn-compressor-remote
    visibleif: $$qc_remote_enabled === "true"  
  tof_dcs_sor_parameters: !public
    value: "{}"
    type: string
    label: "TOF SOR parameters"
    description: "additional parameters for the DCS SOR"
    widget: editBox
    panel: DCS
    visibleif: $$dcs_enabled === "true"
  tof_dcs_eor_parameters: !public
    value: "{}"
    type: string
    label: "TOF EOR parameters"
    description: "additional parameters for the DCS EOR"
    widget: editBox
    panel: DCS
    visibleif: $$dcs_enabled === "true"
  tpc_dpl_workflow: !public
    value: "none"
    type: string
    label: "TPC FLP workflow"
    description: "Workflow to execute on the FLPs of this detector"
    widget: dropDownBox
    panel: FLP_Workflows
    values:
      - none
      - minimal-dpl
      - qc-daq
      - qcmn-daq-local
  tpc_qc_remote_workflow: !public
    value: "none"
    type: string
    label: "TPC QC node workflow"
    description: "Workflow to execute on QC servers for this detector"
    widget: dropDownBox
    panel: FLP_Workflows
    values:
      - none
      - qcmn-daq-remote
      - tpc-full-qcmn-remote
      - tpc-full-nodummy-qcmn-remote
      - tpc-full-nodummy-qcmn-pp-remote
      - tpc-full-calib-remote
      - tpc-krypton-qcmn-remote
    visibleif: $$qc_remote_enabled === "true"  
  tpc_dcs_sor_parameters: !public
    value: "{}"
    type: string
    label: "TPC SOR parameters"
    description: "additional parameters for the DCS SOR"
    widget: editBox
    panel: DCS
    visibleif: $$dcs_enabled === "true"
  tpc_dcs_eor_parameters: !public
    value: "{}"
    type: string
    label: "TPC EOR parameters"
    description: "additional parameters for the DCS EOR"
    widget: editBox
    panel: DCS
    visibleif: $$dcs_enabled === "true"
  trd_dpl_workflow: !public
    value: "none"
    type: string
    label: "TRD FLP workflow"
    description: "Workflow to execute on the FLPs of this detector"
    widget: dropDownBox
    panel: FLP_Workflows
    values:
      - none
      - minimal-dpl
      - qc-daq
      - qcmn-daq-local
  trd_qc_remote_workflow: !public
    value: "none"
    type: string
    label: "TRD QC node workflow"
    description: "Workflow to execute on QC servers for this detector"
    widget: dropDownBox
    panel: FLP_Workflows
    values:
      - none
      - qcmn-daq-remote
      - trd-full-qcmn-epn
      - trd-full-qcmn-norawdatastats-epn
      - trd-full-qcmn-nodigits-epn
      - trd-full-qcmn-notracklets-epn
      - trd-full-qcmn-nopulseheight-epn
    visibleif: $$qc_remote_enabled === "true"  
  trd_dcs_sor_parameters: !public
    value: "{}"
    type: string
    label: "TRD SOR parameters"
    description: "additional parameters for the DCS SOR"
    widget: editBox
    panel: DCS
    visibleif: $$dcs_enabled === "true"
  trd_dcs_eor_parameters: !public
    value: "{}"
    type: string
    label: "TRD EOR parameters"
    description: "additional parameters for the DCS EOR"
    widget: editBox
    panel: DCS
    visibleif: $$dcs_enabled === "true"
  tst_dpl_workflow: !public
    value: "none"
    type: string
    label: "TST FLP workflow"
    description: "Workflow to execute on the FLPs of this detector"
    widget: dropDownBox
    panel: FLP_Workflows
    values:
      - none
      - minimal-dpl
      - qc-daq
      - qcmn-daq-local
  tst_qc_remote_workflow: !public
    value: "none"
    type: string
    label: "TST QC node workflow"
    description: "Workflow to execute on QC servers for this detector"
    widget: dropDownBox
    panel: FLP_Workflows
    values:
      - none
      - qcmn-daq-remote
    visibleif: $$qc_remote_enabled === "true"  
  zdc_dpl_workflow: !public
    value: "none"
    type: string
    label: "ZDC FLP workflow"
    description: "Workflow to execute on the FLPs of this detector"
    widget: dropDownBox
    panel: FLP_Workflows
    values:
      - none
      - minimal-dpl
      - qc-daq
      - qcmn-daq-local
  zdc_qc_remote_workflow: !public
    value: "none"
    type: string
    label: "ZDC QC node workflow"
    description: "Workflow to execute on QC servers for this detector"
    widget: dropDownBox
    panel: FLP_Workflows
    values:
      - none
      - qcmn-daq-remote
    visibleif: $$qc_remote_enabled === "true"  
  zdc_dcs_sor_parameters: !public
    value: "{}"
    type: string
    label: "ZDC SOR parameters"
    description: "additional parameters for the DCS SOR"
    widget: editBox
    panel: DCS
    visibleif: $$dcs_enabled === "true"
  zdc_dcs_eor_parameters: !public
    value: "{}"
    type: string
    label: "ZDC EOR parameters"
    description: "additional parameters for the DCS EOR"
    widget: editBox
    panel: DCS
    visibleif: $$dcs_enabled === "true"
  ###############################
  # TRG Panel
  ###############################
  trg_load_parameters: !public
    value: "GLOBAL.pd"
    type: string
    label: "CTP Configuration"
    description: "Configuration file for the TRG/CTP Global Run"
    widget: comboBox
    values:
      - "GLOBAL.pd"
    panel: TRG
    index: 1
    visibleif: $$trg_enabled === "true" && $$trg_global_run_enabled === "true"
  trg_runtime_config_file: !public
    value: ""
    type: string
    label: "LTU Configuration"
    description: "configuration file for the LTU Standalone Run"
    widget: editBox
    panel: TRG
    visibleif: $$trg_enabled === "true" && $$trg_global_run_enabled === "false"
    index: 2    
  # !! Not used by the ctpd !!
  # trg_run_mode: !public
  #   value: "none"
  #   type: string
  #   label: "TRG Start Run Trigger Mode"
  #   description: "config for the TRG Run Start"
  #   widget: dropDownBox
  #   panel: TRG
  #   values:
  #     - none
  #     - trig
  #     - cont
  # trg_run_ph_bc: !public
  #   value: ""
  #   type: string
  #   label: "TRG Start Run Ph Bc"
  #   description: "BC-downscaled rate of physics triggers"
  #   widget: editBox
  #   panel: TRG
  # trg_run_ph_rnd: !public
  #   value: ""
  #   type: string
  #   label: "TRG Start PH RND"
  #   description: "rate of physics triggers generated randomly"
  #   widget: editBox
  #   panel: TRG
  ###############################
  # Logging Panel
  ###############################
  infologger_severity: !public
    value: info
    type: string
    label: "DPL log level"
    description: "Minimum DPL logging severity which is sent to InfoLogger"
    widget: dropDownBox
    panel: Logging
    values:
      - "nolog"
      - "fatal"
      - "error"
      - "warn"
      - "state"
      - "info"
      - "debug"
      - "debug1"
      - "debug2"
      - "debug3"
      - "debug4"
      - "trace"
    index: 1
  log_task_output: !public
    value: none
    type: string
    label: "Task stdout"
    description: "Select to where the standard output of controlled tasks should be forwarded to (select 'all' for InfoLogger)"
    widget: dropDownBox
    panel: Logging
    values:
      - "none"
      - "stdout"
      - "all"
    index: 2
  fmq_rate_logging: !public
    value: "0"
    type: number
    label: "FairMQ rate logging"
    description: "sets the interval at which FairMQ logs channel transfer rates (0 to disable)"
    widget: editBox
    panel: Logging
    index: 3
  ###############################
  # EPN Workflows Panel
  ###############################
  pdp_generator_script_path: /home/epn/pdp/gen_topo.sh
  pdp_panel_mode: !public
    value: "Shifter"
    type: string
    label: "Panel mode"
    description: ""
    widget: radioButtonBox
    panel: "EPN_Workflows"
    values:
      - "Shifter"
      - "Expert"
    index: -1000
    visibleif: $$epn_enabled === "true"
  odc_n_epns: !public
    value: "10"
    type: number
    label: "# of EPNs"
    description: "Number of EPNs to use"
    widget: editBox
    panel: "EPN_Workflows"
    index: -999
    visibleif: $$epn_enabled === "true"
  odc_n_epns_max_fail: !public
    value: "0"
    type: number
    label: "Max # of EPNs allowed to fail (not yet working)"
    description: "Maximum number of EPNs that are allowed to fail during startup without triggering an error during start of run"
    widget: editBox
    panel: "EPN_Workflows"
    index: -998
    visibleif: $$epn_enabled === "true"
  pdp_config_option: !public
    value: "Repository hash"
    type: string
    label: "Workflow configuration mode"
    description: ""
    widget: dropDownBox
    panel: "EPN_Workflows"
    values:
      - "Repository hash"
      - "Repository path"
      - "Manual XML"
    index: -800
    visibleif: $$epn_enabled === "true" && $$pdp_panel_mode === "Expert"
  odc_topology: !public
    value: ""
    type: string
    label: "Topology"
    description: "DDS topology name to be executed on EPNs"
    widget: editBox
    panel: "EPN_Workflows"
    index: -799
    visibleif: $$epn_enabled === "true" && $$pdp_config_option === "Manual XML"
  pdp_o2_data_processing_hash: !public
    value: "default"
    type: string
    label: "O2DPG Hash"
    description: "Commit hash or tag of O2DPG to use"
    widget: editBox
    panel: "EPN_Workflows"
    index: -799
    visibleif: $$epn_enabled === "true" && $$pdp_config_option === "Repository hash" && $$pdp_panel_mode === "Expert"
  pdp_o2_data_processing_path: !public
    value: ""
    type: string
    label: "O2DPG DATA Path"
    description: "Path to the DATA folder of the O2DPG repository to use in the EPN shared home folder"
    widget: editBox
    panel: "EPN_Workflows"
    index: -799
    visibleif: $$epn_enabled === "true" && $$pdp_config_option === "Repository path"
  pdp_o2pdpsuite_version: !public
    value: "default"
    type: string
    label: "O2PDPSuite Version"
    description: "Version of O2PDPSuite to be used. Set to 'default' to use the default version set by RC. Set to empty '' to use the default version of the workflow. Otherwise specify the O2PDPSuite package(s) to load."
    widget: editBox
    panel: "EPN_Workflows"
    index: -798
    visibleif: $$epn_enabled === "true" && ($$pdp_config_option === "Repository hash" || $$pdp_config_option === "Repository path") && $$pdp_panel_mode === "Expert"
  pdp_qcjson_version: !public
    value: "default"
    type: string
    label: "QC JSON Version"
    description: "Version of QC JSON files to fetch from consul. Set to 'default' to use the default version set by RC. Otherwise specify the version directly."
    widget: editBox
    panel: "EPN_Workflows"
    index: -797
    visibleif: $$epn_enabled === "true" && ($$pdp_config_option === "Repository hash" || $$pdp_config_option === "Repository path") && $$pdp_panel_mode === "Expert"
  odc_resources_spec: !public
    value: "default"
    type: string
    label: "Resources"
    description: "EPN resources to be used, the value 'default' results in '{\"zone\":\"online\", \"n\":N}' where N is the value set in '# of EPNs'"
    widget: editBox
    panel: "EPN_Workflows"
    index: -600
    visibleif: $$epn_enabled === "true" && $$pdp_panel_mode === "Expert"
  stfb_dd_mode: !public
    value: "physics"
    type: string
    label: "Data Distribution mode"
    description: "Data Distribution mode. physics: standard time based data distribution. topology: special topological data distribution for ITS and MFT calibration runs."
    widget: dropDownBox
    panel: "EPN_Workflows"
    values:
      - physics
      - topology
    index: -599
    visibleif: $$epn_enabled === "true" && $$pdp_panel_mode === "Expert"
  tfb_dd_mode: !public
    value: "processing"
    type: string
    label: "TF Builder mode"
    description: "Time Frame Builder mode. processing: TfBuilder builds time frames and forwards them to DPL. disk: TfBuilder builds time frames and stores the raw time frame to disk. processing-disk: combination of processing and disk. discard: TfBuilder builds time frames in memory and discards them immediately."
    widget: dropDownBox
    panel: "EPN_Workflows"
    values:
      - discard
      - disk
      - processing
      - processing-disk
    index: -598
    visibleif: $$epn_enabled === "true" && ($$pdp_config_option === "Repository hash" || $$pdp_config_option === "Repository path") && $$pdp_panel_mode === "Expert"
  pdp_topology_description_library_file: !public
    value: "production/production.desc"
    type: string
    label: "Topology description library file"
    description: "Topology description file in O2DPG repository"
    widget: comboBox
    panel: "EPN_Workflows"
    values:
      - "production/production.desc"
      - "production/no-processing.desc"
    index: 100
    visibleif: $$epn_enabled === "true" && ($$pdp_config_option === "Repository hash" || $$pdp_config_option === "Repository path") && ($$tfb_dd_mode === "processing" || $$tfb_dd_mode === "processing-disk") && $$pdp_panel_mode === "Expert"
  pdp_workflow_name: !public
    value: "synchronous-workflow"
    type: string
    label: "Workflow name"
    description: "Workflow name in the topology description library file"
    widget: comboBox
    panel: "EPN_Workflows"
    values:
      - "synchronous-workflow"
      - "synchronous-workflow-1numa"
    index: 101
    visibleif: $$epn_enabled === "true" && ($$pdp_config_option === "Repository hash" || $$pdp_config_option === "Repository path") && ($$tfb_dd_mode === "processing" || $$tfb_dd_mode === "processing-disk") && $$pdp_panel_mode === "Expert"
  epn_store_raw_data_fraction: !public
    value: "100"
    type: number
    label: "% of raw data to store"
    description: "In case of a 'disk' TfBuilder mode, selects the fraction of raw data to be stored in percent"
    widget: editBox
    panel: "EPN_Workflows"
    index: 102
    visibleif: $$epn_enabled === "true" && ($$pdp_config_option === "Repository hash" || $$pdp_config_option === "Repository path") && ($$tfb_dd_mode === "disk" || $$tfb_dd_mode === "processing-disk") && $$pdp_panel_mode === "Expert"
  pdp_detector_list_global: !public
    value: "default"
    type: string
    label: "Detector list (Global)"
    description: "Comma-separated list of detectors for EPN processing. Empty string means no detectors. 'default' is an abbreviation to include all detectors."
    widget: editBox
    panel: "EPN_Workflows"
    index: 600
    visibleif: $$epn_enabled === "true" && ($$pdp_config_option === "Repository hash" || $$pdp_config_option === "Repository path") && $$pdp_panel_mode === "Expert"
  pdp_detector_list_qc: !public
    value: "default"
    type: string
    label: "Detector list (QC)"
    description: "Comma-separated list of detectors for EPN QC. Empty string means no detectors. 'default' is an abbreviation to include all detectors."
    widget: editBox
    panel: "EPN_Workflows"
    index: 601
    visibleif: $$epn_enabled === "true" && ($$pdp_config_option === "Repository hash" || $$pdp_config_option === "Repository path") && $$pdp_panel_mode === "Expert"
  pdp_detector_list_calib: !public
    value: "default"
    type: string
    label: "Detector list (Calibration)"
    description: "Comma-separated list of detectors for calibration. Empty string means no detectors. 'default' is an abbreviation to include all detectors."
    widget: editBox
    panel: "EPN_Workflows"
    index: 602
    visibleif: $$epn_enabled === "true" && ($$pdp_config_option === "Repository hash" || $$pdp_config_option === "Repository path") && $$pdp_panel_mode === "Expert"
  pdp_workflow_parameters: !public
    value: "QC,CALIB,GPU,CTF,EVENT_DISPLAY"
    type: string
    label: "Workflow parameters"
    description: "Comma-separated list of workflow parameters. Valid parameters are: QC,CALIB,GPU,CTF,EVENT_DISPLAY."
    widget: editBox
    panel: "EPN_Workflows"
    index: 603
    visibleif: $$epn_enabled === "true" && ($$pdp_config_option === "Repository hash" || $$pdp_config_option === "Repository path") && $$pdp_panel_mode === "Expert"
  pdp_raw_decoder_multi_factor: !public
    value: "1"
    type: number
    label: "Raw decoder multiplicity factor"
    description: "Multiply the number of raw decoder processing instance on EPN by this factor"
    widget: editBox
    panel: "EPN_Workflows"
    index: 604
    visibleif: $$epn_enabled === "true" && ($$pdp_config_option === "Repository hash" || $$pdp_config_option === "Repository path") && $$pdp_panel_mode === "Expert"
  pdp_ctf_encoder_multi_factor: !public
    value: "1"
    type: number
    label: "CTF encoder multiplicity factor"
    description: "Multiply the number of CTF encoder processing instance on EPN by this factor"
    widget: editBox
    panel: "EPN_Workflows"
    index: 605
    visibleif: $$epn_enabled === "true" && ($$pdp_config_option === "Repository hash" || $$pdp_config_option === "Repository path") && $$pdp_panel_mode === "Expert"
  pdp_reco_process_multi_factor: !public
    value: "1"
    type: number
    label: "Reconstruction process multiplicity factor"
    description: "Multiply the number of instances of other reconstruction processes by this factor"
    widget: editBox
    panel: "EPN_Workflows"
    index: 606
    visibleif: $$epn_enabled === "true" && ($$pdp_config_option === "Repository hash" || $$pdp_config_option === "Repository path") && $$pdp_panel_mode === "Expert"
  pdp_extra_env_vars: !public
    value: ""
    type: string
    label: "Extra ENV variables"
    description: "Additional environment variables exported when running the workflow generation script"
    widget: editBox
    panel: "EPN_Workflows"
    index: 700
    visibleif: $$epn_enabled === "true" && ($$pdp_config_option === "Repository hash" || $$pdp_config_option === "Repository path") && $$pdp_panel_mode === "Expert"
  pdp_epn_shmid: !public
    value: "1"
    type: string
    label: "EPN SHM Id"
    description: "If the EPN SHM Manager tool is used, the SHMId configured here must match the SHM Id used by the tool"
    widget: editBox
    panel: "EPN_Workflows"
    index: 701
    visibleif: $$epn_enabled === "true" && ($$pdp_config_option === "Repository hash" || $$pdp_config_option === "Repository path") && $$pdp_panel_mode === "Expert"
  pdp_epn_shm_recreate: !public
    value: "false"
    type: bool
    label: "Recreate EPN SHM Segments (not working)"
    description: "If the EPN SHM Manager tool is used, this instructs it to destroy and recreate the segment."
    widget: editBox
    panel: "EPN_Workflows"
    index: 701
    visibleif: $$epn_enabled === "true" && ($$pdp_config_option === "Repository hash" || $$pdp_config_option === "Repository path") && $$pdp_panel_mode === "Expert"
  pdp_wipe_workflow_cache: !public
    value: "false"
    type: bool
    label: "Wipe workflow cache"
    description: "Delete workflow cache"
    widget: checkBox
    panel: "EPN_Workflows"
    index: 703
    visibleif: $$epn_enabled === "true" && ($$pdp_config_option === "Repository hash" || $$pdp_config_option === "Repository path") && $$pdp_panel_mode === "Expert"
  pdp_beam_type: !public
    value: "cosmic"
    type: string
    label: "Beam type"
    description: "Beam type used in this environment"
    widget: dropDownBox
    panel: "EPN_Workflows"
    values:
      - PbPb
      - pp
      - pPb
      - cosmic
      - technical
    index: 800
    visibleif: $$epn_enabled === "true" && ($$pdp_config_option === "Repository hash" || $$pdp_config_option === "Repository path") && $$pdp_panel_mode === "Expert"
  pdp_n_hbf_per_tf: !public
    value: "128"
    type: number
    label: "# of HBFs per TF"
    description: "Number of HBFs per TF for EPN processing"
    widget: editBox
    panel: "EPN_Workflows"
    index: 801
    visibleif: $$epn_enabled === "true" && ($$pdp_config_option === "Repository hash" || $$pdp_config_option === "Repository path") && $$pdp_panel_mode === "Expert"
  odc_partitions_cleanup: !public
    value: "true"
    type: bool
    label: "EPN partitions cleanup"
    description: "If enabled, orphaned EPN partitions are cleaned up on environment deployment and shutdown"
    widget: checkBox
    panel: "EPN_Workflows"
    index: 900
    visibleif: $$epn_enabled === "true" && $$pdp_panel_mode === "Expert"
  ###############################
  # CTP readout Panel
  ###############################
  ctp_readout_host: #!public
    value: "alio2-cr1-flp163"
    type: string
    label: "CTP Readout host"
    description: "Defines the host that runs CTP readout"
    widget: editBox
    panel: "CTP_Readout"
    index: 0
  ###############################
  # Timeouts
  ###############################
  ccdb_start_timeout: "10s"
  ccdb_stop_timeout: "10s"
  dcs_sor_timeout: "140s"
  dcs_eor_timeout: "30s"
  dcs_cleanup_timeout: "30s"
  ddsched_initialize_timeout: "300s"
  ddsched_terminate_timeout: "300s"
  ddsched_cleanup_timeout: "60s"
  drop_caches_timeout: "30s"  
  fmq_initial_shm_cleanup_timeout: "30s"
  fmq_shmmonitor_timeout: "10s"
  odc_partition_cleanup_timeout: "60s"
  odc_partitioninitialize_timeout: "60s"
  odc_configure_timeout: "60s"
  odc_start_timeout: "60s"
  odc_stop_timeout: "60s"
  odc_reset_timeout: "60s"
  odc_partitionterminate_timeout: "60s"
  odc_cleanup_timeout: "60s"
  roc_cleanup_timeout: "10s"
  trg_ctp_emulator_timeout: "10s"
  trg_load_timeout: "5s"
  trg_start_timeout: "5s"
  trg_pre_start_timeout: "5s"
  trg_stop_timeout: "5s"
  trg_unload_timeout: "5s"
  trg_cleanup_timeout: "5s"
  ###############################
  # Detector selection Panel
  ###############################
  detectors: !public
    value: "{{ DetectorsForHosts(hosts) }}"
    type: string
    widget: detectorSelector
    panel: Detectors
  ###############################
  # Other variables
  ###############################    
  ccdb_enabled: "false"
  dpl_workflow: none
  dpl_command: none
  drop_caches_enabled: "true"
  fmq_initial_shm_cleanup_enabled: "false"
  fmq_cleanup_enabled: "true"
  kafka_enabled: "false"
  minimal_dpl_enabled: "false" # TODO FOR LATER: I think this one is no longer needed, we now enabled/disable the Minimal DPL workflow on FLP via dpl_workflow
  monitoring_dd_url: "no-op://"
  monitoring_dpl_url: "no-op://"
  monitoring_qc_url: "no-op://"
  monitoring_readout_url: "no-op://" # TODO: is this used somewhere ? I could not find it anywhere in the workflows
  o2_install_path: "/opt/o2"
  o2_infologger_path: "/opt/o2-InfoLogger"
  odc_plugin: "epn"
  qcdd_enabled: "false" # TODO FOR LATER: I think this one is no longer needed, we now enabled/disable the DAQ QC on FLP via dpl_workflow
  roc_cleanup_enabled: "true"
  roc_ctp_emulator_enabled: "false"
  stfb_standalone: "false"
  user: flp
  extra_env_vars: ""
vars:
  detectors: "{{ DetectorsForHosts(hosts) }}"
  ddsched_enabled: "{{ epn_enabled == 'true' && dd_enabled == 'true' }}"
  odc_enabled: "{{ epn_enabled }}"
roles:
  ##################
  # CTP Readout role
  ##################
  - name: "readout-ctp"
    enabled: "{{ ctp_readout_enabled == 'true' }}"
    vars:
      detector: "{{ctp_readout_enabled == 'true' ? DetectorForHost( ctp_readout_host ) : \"\" }}"
      readout_cfg_uri_standalone: "consul-ini://{{ consul_endpoint }}/o2/components/readout/ANY/any/readout-standalone-{{ ctp_readout_host }}"
      readout_cfg_uri_stfb: "consul-ini://{{ consul_endpoint }}/o2/components/readout/ANY/any/readout-stfb-{{ ctp_readout_host }}"
      dd_discovery_ib_hostname: "{{ ctp_readout_host }}-ib" # MUST be defined for all stfb and stfs
    constraints:
      - attribute: machine_id
        value:  "{{ ctp_readout_host }}"
    roles:
      - name: "readout"
        vars:
          readout_cfg_uri: '{{dd_enabled == "true" ? readout_cfg_uri_stfb : readout_cfg_uri_standalone}}'
        task:
          load: readout
      - name: "data-distribution"
        enabled: "{{ dd_enabled == 'true' }}"
        roles:
          - name: "stfb"
            vars:
              dd_discovery_stfb_id: stfb-{{ ctp_readout_host }}-{{ NewID() }} # must be defined for all stfb roles
            connect:
              - name: readout
                type: pull
                target: "{{ Up(2).Path }}.readout:readout"
                rateLogging: "{{ fmq_rate_logging }}"
            task:
              load: stfbuilder-senderoutput
          - name: "stfs"
            vars:
              dd_discovery_stfs_id: stfs-{{ ctp_readout_host }}-{{ NewID() }} # must be defined for all stfs roles
              stfs_input_channel_name: buildertosender
            connect:
              - name: buildertosender
                type: pull
                target: "{{ Parent().Path }}.stfb:buildertosender"
                rateLogging: "{{ fmq_rate_logging }}"
            task:
              load: stfsender
      - name: drop-caches
        enabled: "{{drop_caches_enabled == 'true'}}"
        vars:
          shell_command: echo 3 > /proc/sys/vm/drop_caches && echo "system caches dropped" | O2_SYSTEM=ECS O2_PARTITION={{environment_id}} O2_ROLE={{it}} {{o2_infologger_path}}/bin/o2-infologger-log -x -s Info -o Facility=core/dropcaches
          user: root
        task:
          load: "shell-command"
          trigger: before_CONFIGURE
          timeout: "{{ drop_caches_timeout }}"
          critical: false # TODO: if this is set true, some basic task finished events aren't parsed correctly
      - name: fairmq-shmcleanup
        enabled: "{{fmq_initial_shm_cleanup_enabled == 'true'}}"
        vars:
          shell_command: "source /etc/profile.d/o2.sh && O2_PARTITION={{environment_id}} O2_ROLE={{it}} o2-aliecs-shmcleaner"
          user: root
        task:
          load: "shell-command"
          trigger: before_DEPLOY
          timeout: "{{ fmq_initial_shm_cleanup_timeout }}"
          critical: false
      - name: fairmq-shmmonitor
        enabled: "{{fmq_cleanup_enabled == 'true'}}"
        task:
          load: "fairmq-shmmonitor"
          trigger: DESTROY
          timeout: 10s
          critical: false
  ##################
  # CTP Readout role
  ##################
  - name: host-{{ it }}
    for:
      range: "{{ hosts }}"
      var: it
    vars:
      detector: "{{DetectorForHost( it )}}"
      readout_cfg_uri_standalone: "consul-ini://{{ consul_endpoint }}/o2/components/readout/ANY/any/readout-standalone-{{ it }}"
      readout_cfg_uri_stfb: "consul-ini://{{ consul_endpoint }}/o2/components/readout/ANY/any/readout-stfb-{{ it }}"
      dd_discovery_ib_hostname: "{{ it }}-ib" # MUST be defined for all stfb and stfs
      # dpl_workflow is set to <detector>_dpl_workflow if such an override exists
      dpl_workflow: "{{ PrefixedOverride( 'dpl_workflow', ToLower( DetectorForHost( it ) ) ) }}"
      dpl_command: "{{ PrefixedOverride( 'dpl_command', ToLower( DetectorForHost( it ) ) ) }}"
    constraints:
      - attribute: machine_id
        value: "{{ it }}"
    roles:
      - name: "readout"
        vars:
          readout_cfg_uri: '{{dd_enabled == "true" ? readout_cfg_uri_stfb : readout_cfg_uri_standalone}}'
        task:
          load: readout
      - name: "data-distribution"
        enabled: "{{dd_enabled == 'true' && (qcdd_enabled == 'false' && minimal_dpl_enabled == 'false' && dpl_workflow == 'none' && dpl_command == 'none')}}"
        roles:
          - name: "stfb-standalone"
            enabled: "{{stfb_standalone}}"
            connect:
              - name: readout
                type: pull
                target: "{{ Up(2).Path }}.readout:readout"
                rateLogging: "{{ fmq_rate_logging }}"
            task:
              load: stfbuilder-nooutput
          - name: "stfb"
            enabled: "{{stfb_standalone == 'false'}}"
            vars:
              dd_discovery_stfb_id: stfb-{{ it }}-{{ NewID() }} # must be defined for all stfb roles
            connect:
              - name: readout
                type: pull
                target: "{{ Up(2).Path }}.readout:readout"
                rateLogging: "{{ fmq_rate_logging }}"
            task:
              load: stfbuilder-senderoutput
          - name: "stfs"
            enabled: "{{stfb_standalone == 'false'}}"
            vars:
              dd_discovery_stfs_id: stfs-{{ it }}-{{ NewID() }} # must be defined for all stfs roles
              stfs_input_channel_name: buildertosender
            connect:
              - name: buildertosender
                type: pull
                target: "{{ Parent().Path }}.stfb:buildertosender"
                rateLogging: "{{ fmq_rate_logging }}"
            task:
              load: stfsender
      - name: "data-distribution-dpl"
        enabled: "{{(qcdd_enabled == 'true' || minimal_dpl_enabled == 'true' || dpl_workflow != 'none' || dpl_command != 'none') && dd_enabled == 'true'}}"
        defaults:
          path_to_readout_proxy: "{{ Parent().Path }}.data-distribution-dpl.stfb:dpl-chan"
        roles:
          - name: "stfb"
            enabled: "{{stfb_standalone == 'false'}}"
            vars:
              dd_discovery_stfb_id: stfb-{{ it }}-{{ NewID() }}
            connect:
              - name: readout
                type: pull
                target: "{{ Up(2).Path }}.readout:readout"
                rateLogging: "{{ fmq_rate_logging }}"
            bind:
              - name: dpl-chan
                type: push
                rateLogging: "{{ fmq_rate_logging }}"
                transport: shmem
                addressing: ipc
                sndBufSize: "4"
                global: "readout-proxy-{{ it }}"
            task:
              #NOTE: plain stfbuilder TT (not stfbuilder-senderoutput) because we want dpl-chan
              load: stfbuilder
          - name: "stfs" # this stfs is for any DPL workflow. We assume that it has a device dpl-output-proxy and a downstream channel
            enabled: "{{stfb_standalone == 'false' && (qcdd_enabled == 'true' || minimal_dpl_enabled == 'true' || dpl_workflow != 'none' || dpl_command != 'none')}}"
            vars:
              dd_discovery_stfs_id: stfs-{{ it }}-{{ NewID() }}
              stfs_input_channel_name: downstream
            connect:
              - name: downstream
                type: pull
                target: "::downstream-{{ it }}" # The subwf must provide this channel!
                rateLogging: "{{ fmq_rate_logging }}"
            task:
              load: stfsender
          - name: dpl
            enabled: "{{ qcdd_enabled == 'true' }}"
            include: qc-daq
          - name: dpl
            enabled: "{{ minimal_dpl_enabled == 'true' }}"
            include: minimal-dpl
          - name: dpl
            enabled: "{{ dpl_workflow != 'none' }}"
            include: "{{ dpl_workflow }}"
          - name: dpl
            vars:
              sourced_dpl_command: "source /etc/profile.d/o2.sh && {{ dpl_command }}"
            enabled: "{{ dpl_command != 'none' }}"
            include: "{{ GenerateDplSubworkflow(sourced_dpl_command) }}"
      - name: o2-roc-ctp-emulators
        enabled: "{{roc_ctp_emulator_enabled == 'true'}}"
        defaults:
          roc_ctp_emulator_endpoints: '["#0"]'
        roles:
          - name: "endpoint-{{ endpoint_id }}"
            for:
              range: "{{roc_ctp_emulator_endpoints}}"
              var: endpoint_id
            roles:
              - name: o2-roc-ctp-emulator
                task:
                  load: "o2-roc-ctp-emulator"
                  trigger: enter_RUNNING
                  timeout: "{{ trg_ctp_emulator_timeout }}"
                  critical: false
      - name: drop-caches
        enabled: "{{drop_caches_enabled == 'true'}}"
        vars:
          shell_command: echo 3 > /proc/sys/vm/drop_caches && echo "system caches dropped" | O2_SYSTEM=ECS O2_PARTITION={{environment_id}} O2_ROLE={{it}} {{o2_infologger_path}}/bin/o2-infologger-log -x -s Info -o Facility=core/dropcaches
          user: root
        task:
          load: "shell-command"
          trigger: before_CONFIGURE
          timeout: "{{ drop_caches_timeout }}"
          critical: false # TODO: if this is set true, some basic task finished events aren't parsed correctly
      - name: fairmq-shmcleanup
        enabled: "{{fmq_initial_shm_cleanup_enabled == 'true'}}"
        vars:
          shell_command: "source /etc/profile.d/o2.sh && O2_PARTITION={{environment_id}} O2_ROLE={{it}} o2-aliecs-shmcleaner"
          user: root
        task:
          load: "shell-command"
          trigger: before_DEPLOY
          timeout: "{{ fmq_initial_shm_cleanup_timeout }}"
          critical: false
      - name: fairmq-shmmonitor
        enabled: "{{fmq_cleanup_enabled == 'true'}}"
        task:
          load: "fairmq-shmmonitor"
          trigger: DESTROY
          timeout: "{{ fmq_shmmonitor_timeout }}"
          critical: false
      - name: o2-roc-cleanup
        enabled: "{{roc_cleanup_enabled == 'true'}}"
        task:
          load: "o2-roc-cleanup"
          trigger: DESTROY
          timeout: "{{ roc_cleanup_timeout }}"
          critical: false
      - name: ps-aux-on-destroy
        vars:
          shell_command: ps aux|grep OCCPlugin
        task:
          load: "shell-command"
          trigger: DESTROY
          timeout: 10s
          critical: false
  - name: qc-servers
    enabled: "{{ qc_remote_enabled == 'true' }}"
    constraints:
      - attribute: machine_type
        value: qcserver
    defaults:
      qc_remote_workflow: none
    vars:
      user: qc
      session_id: "{{ environment_id }}" # we can't use "default" because other workflows might already exist on the same QC server
    roles:
      - name: qc-remote-workflow-{{ det }}
        for:
          range: "{{ detectors }}"
          var: det
        vars:
          qc_remote_workflow: "{{ PrefixedOverride( 'qc_remote_workflow', ToLower( det ) ) }}"
        roles:
          - name: dpl
            enabled: "{{ qc_remote_workflow != 'none' }}"
            include: "{{ qc_remote_workflow }}"
          # When qc_remote_enabled is true, it will try to deploy a qc_remote_workflow for every detector in the list
          # however if the {{det}}_qc_remote_workflow is none there is a ghost role deployed which is never active
          # for that cases we deploy a plain echo task which will transition the role and eventually the wf to active
          - name: echo task
            enabled: "{{ qc_remote_workflow == 'none' }}"
            vars:
              shell_command: echo
            task:
              load: "shell-command"
  - name: dcs
    enabled: "{{dcs_enabled == 'true'}}"
    defaults:
    ###############################
    # DCS Panel
    ###############################
      dcs_detectors: "{{ detectors }}"
      dcs_sor_parameters: !public
        value: "{}"
        type: string
        label: "Global SOR parameters"
        description: "additional parameters for the DCS SOR"
        widget: editBox
        panel: DCS
        index: 2
        visibleif: $$dcs_enabled === "true"
      dcs_eor_parameters: !public
        value: "{}"
        type: string
        label: "Global EOR parameters"
        description: "additional parameters for the DCS EOR"
        widget: editBox
        panel: DCS
        index: 3
        visibleif: $$dcs_enabled === "true"
      run_type: !public # enum from AliECS common/runtype
        value: "PHYSICS"
        type: string
        label: "Run Type"
        description: "Run type for DCS SOR/EOR"
        widget: comboBox
        panel: DCS
        values:
          - NONE
          - CALIBRATION_ITHR_TUNING
          - CALIBRATION_VCASN_TUNING
          - CALIBRATION_THR_SCAN
          - CALIBRATION_DIGITAL_SCAN
          - CALIBRATION_ANALOG_SCAN
          - CALIBRATION_FHR
          - CALIBRATION_ALPIDE_SCAN
          - LASER
          - PEDESTAL
          - PHYSICS
          - PULSER
          - TECHNICAL
        index: 4
        visibleif: $$dcs_enabled === "true"
    roles:
      - name: sor
        call:
          func: dcs.StartOfRun()
          trigger: before_START_ACTIVITY
          timeout: "{{ dcs_sor_timeout }}"
          critical: true
      - name: eor
        call:
          func: dcs.EndOfRun()
          trigger: after_STOP_ACTIVITY
          timeout: "{{ dcs_eor_timeout }}"
          critical: true
      - name: cleanup
        call:
          func: dcs.Cleanup()
          trigger: DESTROY
          timeout: "{{ dcs_cleanup_timeout }}"
          critical: true
  - name: dd-scheduler
    enabled: "{{ddsched_enabled == 'true'}}"
    roles:
      - name: initialize
        call:
          func: ddsched.PartitionInitialize()
          trigger: before_CONFIGURE
          await: after_CONFIGURE
          timeout: "{{ ddsched_initialize_timeout }}"
          critical: true
      - name: terminate
        call:
          func: ddsched.PartitionTerminate()
          trigger: after_RESET
          timeout: "{{ ddsched_terminate_timeout }}"	  
          critical: true
      - name: cleanup
        call:
          func: ddsched.EnsureTermination()
          trigger: DESTROY
          timeout: "{{ ddsched_cleanup_timeout }}"	  
          critical: false
  - name: odc
    enabled: "{{odc_enabled == 'true'}}"
    vars:
      odc_resources: '{{TrimSpace(odc_resources_spec) == "default" ? "{\"zone\":\"online\", \"n\":\"" + odc_n_epns + "\"}" : odc_resources_spec }}'
      odc_script: '{{ odc_enabled == "true" ? odc.GenerateEPNWorkflowScript() : "" }}'
    roles:
      - name: deploy
        enabled: "{{odc_partitions_cleanup == 'true'}}"
        call:
          func: odc.PreDeploymentCleanup()
          trigger: before_DEPLOY
          await: after_DEPLOY
          timeout: "{{ odc_partition_cleanup_timeout }}"
          critical: false
      - name: part-init
        call:
          func: odc.PartitionInitialize()
          trigger: before_CONFIGURE-100
          await: before_CONFIGURE-100
          timeout: "{{ odc_partitioninitialize_timeout }}"
          critical: true
      - name: configure
        call:
          func: odc.Configure()
          trigger: before_CONFIGURE
          await: after_CONFIGURE
          timeout: "{{ odc_configure_timeout }}"
          critical: true
      - name: start
        call:
          func: odc.Start()
          trigger: before_START_ACTIVITY
          await: after_START_ACTIVITY
          timeout: "{{ odc_start_timeout }}"
          critical: true
      - name: stop
        call:
          func: odc.Stop()
          trigger: before_STOP_ACTIVITY
          await: after_STOP_ACTIVITY
          timeout: "{{ odc_stop_timeout }}"
          critical: true
      - name: reset
        call:
          func: odc.Reset()
          trigger: before_RESET
          await: after_RESET
          timeout: "{{ odc_reset_timeout }}"
          critical: true
      - name: part-term
        call:
          func: odc.PartitionTerminate()
          trigger: after_RESET+100
          await: after_RESET+100
          timeout: "{{ odc_partitionterminate_timeout }}"
          critical: true
      - name: cleanup
        enabled: "{{odc_partitions_cleanup == 'true'}}"
        call:
          func: odc.EnsureCleanup()
          trigger: DESTROY
          timeout: "{{ odc_cleanup_timeout }}"
          critical: false
      - name: legacy-cleanup
        enabled: "{{odc_partitions_cleanup == 'false'}}"
        call:
          func: odc.EnsureCleanupLegacy()
          trigger: DESTROY
          timeout: "1m"
          critical: false
  - name: trg
    enabled: "{{trg_enabled == 'true'}}"
    defaults:
      trg_detectors: "{{ detectors }}"
      trg_runtime_config: "{{ GetRuntimeConfig('trg/ltu', trg_runtime_config_file) }}"
      trg_global_config: "{{ GetRuntimeConfig('trg/ctp', trg_load_parameters) }}"
    roles:
      - name: load
        call:
          func: trg.RunLoad()
          trigger: enter_RUNNING
          timeout: "{{ trg_load_timeout }}"
          critical: true
      - name: pre-start
        call:
          func: testplugin.Noop()
          trigger: after_START_ACTIVITY-200
          timeout: "{{ trg_pre_start_timeout }}"
          critical: false
      - name: start
        call:
          func: trg.RunStart()
          trigger: after_START_ACTIVITY
          timeout: "{{ trg_start_timeout }}"
          critical: true
      - name: stop
        call:
          func: trg.RunStop()
          trigger: before_STOP_ACTIVITY
          timeout: "{{ trg_stop_timeout }}"
          critical: true
      - name: unload
        call:
          func: trg.RunUnload()
          trigger: after_STOP_ACTIVITY
          timeout: "{{ trg_unload_timeout }}"
          critical: true
      - name: cleanup
        call:
          func: trg.Cleanup()
          trigger: DESTROY-100
          timeout: "{{ trg_cleanup_timeout }}"
          critical: false
  - name: ccdb
    enabled: "{{ccdb_enabled == 'true'}}"
    roles:
      - name: start
        call:
          func: ccdb.RunStart()
          trigger: after_START_ACTIVITY
          timeout: 10s
          critical: false
      - name: stop
        call:
          func: ccdb.RunStop()
          trigger: before_STOP_ACTIVITY
          timeout: 10s
          critical: false
  - name: bookkeeping
    enabled: "{{bookkeeping_enabled == 'true'}}"
    roles:
      - name: start
        call:
          func: bookkeeping.StartOfRun()
          trigger: after_START_ACTIVITY
          timeout: 10s
          critical: false
      - name: updatestart
        call:
          func: bookkeeping.UpdateRunStart()
          trigger: after_START_ACTIVITY
          timeout: 10s
          critical: false
      - name: updatestop
        call:
          func: bookkeeping.UpdateRunStop()
          trigger: after_STOP_ACTIVITY
          timeout: 10s
          critical: false
  - name: kafka
    enabled: "{{ kafka_enabled == 'true' }}"
    roles:
      - name: standby
        call:
          func: kafka.PublishUpdate()
          trigger: enter_STANDBY
          timeout: 5s
          critical: false
      - name: deployed
        call:
          func: kafka.PublishUpdate()
          trigger: enter_DEPLOYED
          timeout: 5s
          critical: false
      - name: configured
        call:
          func: kafka.PublishUpdate()
          trigger: enter_CONFIGURED
          timeout: 5s
          critical: false
      - name: running
        call:
          func: kafka.PublishUpdate()
          trigger: enter_RUNNING
          timeout: 5s
          critical: false
      - name: error
        call:
          func: kafka.PublishUpdate()
          trigger: enter_ERROR
          timeout: 5s
          critical: false
      - name: destroy
        call:
          func: kafka.PublishUpdate()
          trigger: DESTROY
          timeout: 5s
          critical: false
